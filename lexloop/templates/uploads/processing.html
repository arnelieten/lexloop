{% extends 'base.html' %}

{% block title %}Processing{% endblock %}

{% block header %}
<h1>Processing your file</h1>
{% endblock %}

{% block content %}
<div class="processing-container">
  <p class="processing-status" id="processing-status">Startingâ€¦</p>
  <div class="progress-bar-wrap" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="3">
    <div class="progress-bar-fill" id="progress-fill" style="width: 0%;"></div>
  </div>
  <p class="progress-steps" id="progress-steps">Step 0/3</p>
  <p class="processing-error hidden" id="processing-error"></p>
</div>

<script>
(function () {
  var streamUrl = {{ url_for('process.process_file_stream', filename=filename)|tojson }};
  var dashboardUrl = {{ url_for('dashboard.display')|tojson }};

  var statusEl = document.getElementById('processing-status');
  var fillEl = document.getElementById('progress-fill');
  var stepsEl = document.getElementById('progress-steps');
  var errorEl = document.getElementById('processing-error');

  function setStep(step) {
    var pct = step >= 3 ? 100 : (step / 3) * 100;
    fillEl.style.width = pct + '%';
    stepsEl.textContent = 'Step ' + step + '/3';
    fillEl.parentNode.setAttribute('aria-valuenow', step);
  }

  function showError(message) {
    errorEl.innerHTML = (message || 'Something went wrong.') + ' <a href="{{ url_for('uploads.upload_file') }}">Back to upload</a>';
    errorEl.classList.remove('hidden');
    statusEl.textContent = 'Error';
  }

  var es = new EventSource(streamUrl);
  es.onmessage = function (e) {
    var data = JSON.parse(e.data);
    if (data.event === 'step') {
      setStep(data.step);
      statusEl.textContent = data.message || ('Step ' + data.step + '/3');
    } else if (data.event === 'done') {
      setStep(3);
      statusEl.textContent = 'Done!';
      es.close();
      window.location.href = dashboardUrl + '?success=1';
    } else if (data.event === 'error') {
      showError(data.message);
      es.close();
    }
  };
  es.onerror = function () {
    if (errorEl.classList.contains('hidden')) {
      showError('Connection lost. Please try again from the upload page.');
    }
    es.close();
  };
})();
</script>
{% endblock %}
